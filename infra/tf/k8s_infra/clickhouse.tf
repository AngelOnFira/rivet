locals {
	clickhouse_k8s = var.clickhouse_provider == "kubernetes"
}

module "clickhouse_secrets" {
	count = local.clickhouse_k8s ? 1 : 0

	source = "../modules/secrets"

	keys = [
		"clickhouse/users/default/password"
	]
}

resource "kubernetes_namespace" "clickhouse" {
	count = local.clickhouse_k8s ? 1 : 0

	metadata {
		name = "clickhouse"
	}
}

resource "helm_release" "clickhouse" {
	count = local.clickhouse_k8s ? 1 : 0

	name = "clickhouse"
	namespace = kubernetes_namespace.clickhouse[0].metadata.0.name
	repository = "oci://registry-1.docker.io/bitnamicharts"
	chart = "clickhouse"
	version = "3.6.3"
	values = [yamlencode({
		global = {
			storageClass = var.k8s_storage_class
		}
		replicaCount = 1
		shards = 1
		zookeeper = {
			replicaCount = 1
		}
		tls = {
			enabled = true
			autoGenerated = true
		}

		# Disable insecure ports
		extraOverrides = <<-EOF
			<?xml version="1.0"?>
			<clickhouse>
				<http_port remove="remove"/>
				<tcp_port remove="remove"/>
				<interserver_http_port remove="remove"/>
				<interserver_https_port>9010</interserver_https_port>
			</clickhouse>
			EOF

		# Probes can't use https for some reason
		livenessProbe = {
			enabled = false
		}
		readinessProbe = {
			enabled = false
		}
		# TODO: Make probes use secure port
		# customLivenessProbe = {
		# 	httpGet = {
		# 		path = "/ping"
		# 		port = "https"
		# 	}
		# }
		# customReadinessProbe = {
		# 	httpGet = {
		# 		path = "/ping"
		# 		port = "https"
		# 	}
		# }

		# Admin auth
		auth = {
			username = "bolt"
			password = module.clickhouse_secrets[0].values["clickhouse/users/default/password"]
		}
	})]
}

data "kubernetes_secret" "clickhouse_ca" {
	count = local.clickhouse_k8s ? 1 : 0

	depends_on = [helm_release.clickhouse]

	metadata {
		name = "clickhouse-crt"
		namespace = kubernetes_namespace.clickhouse[0].metadata.0.name
	}
}

resource "kubernetes_config_map" "clickhouse_ca" {
	count = local.clickhouse_k8s ? 1 : 0

	metadata {
		name = "clickhouse-ca"
		namespace = "rivet-service"
	}

	data = {
		"ca.crt" = data.kubernetes_secret.clickhouse_ca[0].data["ca.crt"]
	}
}

