module "clickhouse_secrets" {
	source = "../modules/secrets"

	keys = [
		for user in local.clickhouse_users:
		"clickhouse/users/${user}/password"
	]
}

locals {
	clickhouse_users = ["bolt", "chirp", "grafana"]

	clickhouse_auth = {
		for user in local.clickhouse_users:
		user => {
			password = module.clickhouse_secrets.values["clickhouse/users/${user}/password"]
			readonly = user == "grafana"
		}
	}
}

resource "kubernetes_namespace" "clickhouse" {
	metadata {
		name = "clickhouse"
	}
}

resource "helm_release" "clickhouse" {
	name = "clickhouse"
	namespace = kubernetes_namespace.clickhouse.metadata.0.name
	repository = "oci://registry-1.docker.io/bitnamicharts"
	chart = "clickhouse"
	version = "3.6.3"
	values = [yamlencode({
		global = {
			storageClass = var.k8s_storage_class
		}
		replicaCount = 1
		shards = 1
		zookeeper = {
			replicaCount = 1
		}
		tls = {
			enabled = true
			autoGenerated = true
		}

		# Disable insecure ports
		extraOverrides = <<-EOF
			<?xml version="1.0"?>
			<clickhouse>
				<http_port remove="remove"/>
				<tcp_port remove="remove"/>
				<interserver_http_port remove="remove"/>
				<interserver_https_port>9010</interserver_https_port>
			</clickhouse>
			EOF

		# Probes can't use https for some reason
		livenessProbe = {
			enabled = false
		}
		readinessProbe = {
			enabled = false
		}
		# TODO: Make probes use secure port
		# customLivenessProbe = {
		# 	httpGet = {
		# 		path = "/ping"
		# 		port = "https"
		# 	}
		# }
		# customReadinessProbe = {
		# 	httpGet = {
		# 		path = "/ping"
		# 		port = "https"
		# 	}
		# }

		# Admin auth
		auth = {
			username = "bolt"
			password = local.clickhouse_auth["bolt"].password
		}
		# Additional users
		usersExtraOverrides = <<-EOF
			<?xml version="1.0"?>
			<clickhouse>
				<profiles>
					<default>
						<max_memory_usage>10000000000</max_memory_usage>
						<load_balancing>random</load_balancing>
					</default>

					<readonly>
						<readonly>1</readonly>
					</readonly>
				</profiles>

				<users>
					${join(",", [
						for u, v in local.clickhouse_auth:
						<<-EOT
						<${u}>
							<password>${v.password}</password>
							${v.readonly ? "<profile>readonly</profile>" : ""}
						</${u}>
						EOT
					])
					}
				</users>
			</clickhouse>
			EOF
	})]
}

data "kubernetes_secret" "clickhouse_ca" {
	depends_on = [helm_release.clickhouse]

	metadata {
		name = "clickhouse-crt"
		namespace = kubernetes_namespace.clickhouse.metadata.0.name
	}
}

resource "kubernetes_config_map" "clickhouse_ca" {
	metadata {
		name = "clickhouse-ca"
		namespace = "rivet-service"
	}

	data = {
		"ca.crt" = data.kubernetes_secret.clickhouse_ca.data["ca.crt"]
	}
}
